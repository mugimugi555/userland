#!/bin/bash

echo "=========================================="
echo "ðŸš€ UserLAnd ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’è‡ªå‹•èµ·å‹•è¨­å®šã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ"
echo "=========================================="

# ======================================================================
# `cron` ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« & èµ·å‹•
# ======================================================================
echo "ðŸ“Œ cron ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’ç¢ºèª..."
if ! command -v cron &> /dev/null; then
    echo "ðŸ“Œ cron ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
    sudo apt update
    sudo apt install -y cron
fi

echo "ðŸ“Œ cron ã‚’èµ·å‹•..."
sudo service cron start

# ======================================================================
# èµ·å‹•å¯èƒ½ãªã‚µãƒ¼ãƒ“ã‚¹ã‚’æ¤œå‡º
# ======================================================================
SERVICES=("mysql" "apache2" "nginx" "php-fpm")
AUTOSTART_COMMANDS=()

echo "ðŸ“Œ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ç¢ºèª..."
for SERVICE in "${SERVICES[@]}"; do
    if command -v $SERVICE &> /dev/null || sudo service --status-all 2>&1 | grep -q "$SERVICE"; then
        echo "âœ… $SERVICE ã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™ã€‚"
        AUTOSTART_COMMANDS+=("sudo service $SERVICE start")
    else
        echo "âŒ $SERVICE ã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
    fi
done

# ======================================================================
# `cron` ã«è‡ªå‹•èµ·å‹•ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ 
# ======================================================================
if [ ${#AUTOSTART_COMMANDS[@]} -gt 0 ]; then
    echo "ðŸ“Œ `cron` ã«ã‚µãƒ¼ãƒ“ã‚¹ã®è‡ªå‹•èµ·å‹•ã‚’è¿½åŠ ..."
    
    # æ—¢å­˜ã® crontab ã«ã‚ã‚‹ `@reboot` ã‚’å‰Šé™¤ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
    crontab -l 2>/dev/null | grep -v "@reboot" > /tmp/crontab_backup

    # è‡ªå‹•èµ·å‹•ã®ã‚³ãƒžãƒ³ãƒ‰ã‚’è¿½åŠ 
    for CMD in "${AUTOSTART_COMMANDS[@]}"; do
        echo "@reboot $CMD" >> /tmp/crontab_backup
    done

    # `cron` ã«åæ˜ 
    crontab /tmp/crontab_backup
    rm /tmp/crontab_backup

    echo "âœ… `cron` ã«ã‚µãƒ¼ãƒ“ã‚¹ã®è‡ªå‹•èµ·å‹•ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼"
else
    echo "âš ï¸ èµ·å‹•ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
fi

# ======================================================================
# `.bashrc` ã« `cron` ã®è‡ªå‹•èµ·å‹•ã‚’è¿½åŠ 
# ======================================================================
echo "ðŸ“Œ `.bashrc` ã« cron ã®è‡ªå‹•èµ·å‹•ã‚’è¿½åŠ ..."
if ! grep -q "service cron start" ~/.bashrc; then
    echo "sudo service cron start" >> ~/.bashrc
    echo "âœ… `.bashrc` ã« cron ã®è‡ªå‹•èµ·å‹•ã‚’è¨­å®šã—ã¾ã—ãŸï¼"
else
    echo "âœ… `.bashrc` ã«ã¯ã™ã§ã« cron ã®è‡ªå‹•èµ·å‹•è¨­å®šãŒã‚ã‚Šã¾ã™ã€‚"
fi

# ======================================================================
# ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
# ======================================================================
echo "=========================================="
echo "âœ… è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼"
echo "ðŸ’¡ UserLAnd ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å†èµ·å‹•ã™ã‚‹ã¨ã€è‡ªå‹•ã§ä»¥ä¸‹ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒé–‹å§‹ã•ã‚Œã¾ã™ã€‚"
echo "=========================================="
for SERVICE in "${SERVICES[@]}"; do
    if command -v $SERVICE &> /dev/null || sudo service --status-all 2>&1 | grep -q "$SERVICE"; then
        echo "ðŸš€ $SERVICE"
    fi
done
echo "=========================================="
