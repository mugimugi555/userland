#!/bin/bash

echo "=========================================="
echo "ğŸš€ æœ€æ–°ç‰ˆ Nginx ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆ"
echo "=========================================="

# ======================================================================
# è¨­å®š: ä½¿ç”¨ã™ã‚‹ãƒãƒ¼ãƒˆç•ªå·
# ======================================================================
NGINX_PORT=9090

# ======================================================================
# ã‚·ã‚¹ãƒ†ãƒ ã®æº–å‚™
# ======================================================================
VERSION_CODENAME=$(env -i bash -c '. /etc/os-release; echo $VERSION_CODENAME')

echo "ğŸ“Œ å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
sudo apt update -y
sudo apt install -y curl gnupg2 ca-certificates lsb-release debian-archive-keyring

# ======================================================================
# Nginx å…¬å¼ãƒªãƒã‚¸ãƒˆãƒªã®è¿½åŠ 
# ======================================================================
echo "ğŸ“Œ Nginx ã®å…¬å¼ GPG ã‚­ãƒ¼ã‚’è¿½åŠ ..."
wget -qO - http://nginx.org/keys/nginx_signing.key | sudo apt-key add -

echo "ğŸ“Œ Nginx ã®å…¬å¼ãƒªãƒã‚¸ãƒˆãƒªã‚’è¿½åŠ ..."
echo "deb http://nginx.org/packages/debian/ $VERSION_CODENAME nginx" | sudo tee /etc/apt/sources.list.d/nginx.list
echo "deb-src http://nginx.org/packages/debian/ $VERSION_CODENAME nginx" | sudo tee -a /etc/apt/sources.list.d/nginx.list
cat /etc/apt/sources.list.d/nginx.list

# ======================================================================
# æœ€æ–°ã® Nginx ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# ======================================================================
echo "ğŸ“Œ Nginx ã®æœ€æ–°ç‰ˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«..."
sudo apt update
sudo apt install -y nginx

# ======================================================================
# Nginx ã®ãƒãƒ¼ãƒˆã‚’æŒ‡å®šã®å€¤ã«å¤‰æ›´
# ======================================================================
echo "ğŸ“Œ Nginx ã®è¨­å®šã‚’ãƒãƒ¼ãƒˆ $NGINX_PORT ã«å¤‰æ›´..."
sudo sed -i "s/listen 80;/listen $NGINX_PORT;/" /etc/nginx/nginx.conf
sudo sed -i "s/listen \[::\]:80;/listen \[::\]:$NGINX_PORT;/" /etc/nginx/nginx.conf

# ======================================================================
# Nginx ã®å†èµ·å‹•
# ======================================================================
echo "ğŸ“Œ Nginx ã‚’å†èµ·å‹•..."
sudo service nginx restart

# ======================================================================
# Nginx ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
# ======================================================================
echo "ğŸ“Œ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸ Nginx ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèª..."
nginx -v

echo "=========================================="
echo "ğŸ‰ æœ€æ–°ã® Nginx ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« & ãƒãƒ¼ãƒˆè¨­å®šå®Œäº†ï¼"
echo "ğŸ’¡ ã‚¢ã‚¯ã‚»ã‚¹: http://localhost:$NGINX_PORT/"
echo "=========================================="
